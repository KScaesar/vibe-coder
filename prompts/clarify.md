---
name: clarify
description:  根據 .clarify/ 資料夾中的釐清項目，與使用者進行互動式釐清，並將答案即時更新回對應的規格模型檔案
---

# Clarify

## 0. 初始化載入

1. **讀取釐清策略**：載入 `.clarify/overview.md`，取得：
   - 釐清項目總數與分佈
   - 建議的釐清順序（由核心至延伸）
   - 優先級分佈與依賴關係

2. **載入釐清項目**：依照 `overview.md` 建議的順序，讀取所有釐清項目檔案（`.clarify/data/*.md` 和 `.clarify/features/*.md`）

3. **載入現有規格**：將以下規格檔案載入記憶體：
   - `spec/erm.dbml`
   - `spec/features/*.feature`
   - 保持原始格式與結構，供後續增量更新使用
   - **建立術語對照表**：提取所有繁體中文術語（實體名稱、屬性 note、Feature 名稱、步驟用詞），供翻譯時參照

## 1. 建立釐清佇列

根據 `overview.md` 的建議順序，建立優先化的釐清佇列：

### 排序原則

1. **核心優先**：優先處理 High 優先級項目
2. **由核心至延伸**：先處理核心實體與功能，再處理邊界條件與細節
3. **平衡分佈**：在資料模型與功能模型間交替進行，避免連續處理同類問題
4. **依賴關係**：若項目 B 依賴項目 A 的釐清結果，確保 A 先於 B

### 佇列管理

- 初始佇列包含所有釐清項目
- 每個項目標記狀態：Pending（待處理）/ In-Progress（處理中）/ Resolved（已解決）/ Skipped（已跳過）
- 使用者可選擇跳過低優先級項目
- 提前終止時，未處理項目標記為 Deferred

## 2. 逐題提問循環（互動式）

### 2.1 提問流程

**一次只呈現一題**，參考格式如下：

提問範例
```
[釐清進度：第 X / 總 Y 題] [優先級：High/Medium/Low]

# 問題

<白話翻譯版問題>

## 定位

<ERM：哪個實體的哪個屬性？或是哪個關係？>
<Feature：哪個功能的哪條規則？或是哪個 Example？>

## 選項

<呈現多選題表格>

| 選項 | 描述 |
|--------|-------------|
| A | <選項 A 白話描述> |
| B | <選項 B 白話描述> |
| C | <選項 C 白話描述> |
| D | <選項 D 白話描述>（如有）|
| E | <選項 E 白話描述>（如有）|
| Short | 提供其他簡短答案（<=5 字）|
```

### 2.2 回答處理

使用者回答後：

1. **驗證回答**：
   - 檢查回答是否對應某選項（A/B/C/D/E）
   - 若為 Short，確認符合不超過 5~10 字的限制（沒這麼嚴格）
   - 若含糊或不明確，立即要求釐清（仍計入同一題，不前進到下一題）

2. **記錄答案**：
   - 將答案暫存於工作記憶
   - 標記該釐清項目為 Resolved

3. **立即整合**（見步驟 3）

4. **更新進度**：
   - 將該釐清項目從 Pending 改為 Resolved
   - 移至佇列的下一題

### 2.3 終止條件

在下列情況停止繼續提問：

- 所有釐清項目都已處理完畢
- 使用者明確表示終止（如「done」「stop」「no more」「proceed」）
- 剩餘項目僅為 Low 優先級且使用者選擇跳過

**切勿提前透露後續題目**，保持一次一題的節奏。

### 2.4 互動原則

- **單一焦點**：每次只聚焦一個釐清項目，避免混淆
- **快速驗證**：若回答含糊，立即要求釐清，不要臆測
- **進度透明**：每題都顯示進度（第 X / 總 Y 題）
- **優先級可見**：每題都顯示優先級，讓使用者了解重要性

## 行為規則

- **嚴格依序**：按照 `overview.md` 建議的順序提問，不跳題
- **單題單焦點**：一次只呈現一題，等待回答後再進入下一題
- **必先翻譯**：每題提問前，必須先執行白話翻譯，確保問題與選項符合翻譯準則
- **術語精準**：翻譯時必須使用規格檔案中已有的繁體中文術語，嚴禁發明新詞
- **術語對照**：每次翻譯前，從規格檔案中提取該領域的中文術語對照表
- **立即整合**：每個答案接受後立即更新規格檔與釐清項目狀態，不延遲
- **即時歸檔**：每個釐清項目解決後，立即從 `overview.md` 移除並移動至 `.clarify/resolved/`
- **快速驗證**：若回答含糊，立即要求釐清，不臆測使用者意圖
- **尊重終止**：使用者隨時可終止，已處理的釐清項目標記為 Resolved，未處理的標記為 Deferred
- **保留格式**：更新規格檔時保持原有格式與結構，不重新排序無關區段
- **術語一致**：全文使用統一術語，必要時正規化先前的不一致用詞
- **句型統一**：Feature 檔案中的 Step 定義保持句型一致
- **避免重複**：若釐清使先前敘述失效，直接取代，不保留矛盾內容
- **可測試性**：所有插入的釐清內容都應精煉且可驗證
